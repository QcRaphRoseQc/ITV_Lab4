{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "subscriptionId": {
            "type": "string"
        },
        "name": {
            "type": "string"
        },
        "location": {
            "type": "string"
        },
        "hostingPlanName": {
            "type": "string"
        },
        "serverFarmResourceGroup": {
            "type": "string"
        },
        "databaseName": {
            "type": "string"
        },
        "sku": {
            "type": "string"
        },
        "skuCode": {
            "type": "string"
        },
        "workerSize": {
            "type": "string"
        },
        "workerSizeId": {
            "type": "string"
        },
        "numberOfWorkers": {
            "type": "string"
        },
        "linuxFxVersion": {
            "type": "string"
        },
        "storageSizeMB": {
            "type": "int"
        },
        "haEnabled": {
            "type": "string"
        },
        "availabilityZone": {
            "type": "string"
        },
        "backupRetentionDays": {
            "type": "int"
        },
        "geoRedundantBackup": {
            "type": "string"
        },
        "postgreServerSkuName": {
            "type": "string"
        },
        "serverEdition": {
            "type": "string"
        },
        "serverName": {
            "type": "string"
        },
        "serverUsername": {
            "type": "string"
        },
        "serverPassword": {
            "type": "securestring"
        },
        "publicNetworkAccess": {
            "type": "string"
        },
        "isVnetEnabled": {
            "type": "bool"
        },
        "isPrivateEndpointForAppEnabled": {
            "type": "bool"
        },
        "vnetName": {
            "type": "string"
        },
        "privateEndpointSubnet": {
            "type": "string"
        },
        "subnetForApp": {
            "type": "string"
        },
        "subnetForDb": {
            "type": "string"
        },
        "privateEndpointNameForApp": {
            "type": "string"
        },
        "privateEndpointNameForDb": {
            "type": "string"
        },
        "privateDnsZoneNameForApp": {
            "type": "string"
        },
        "privateDnsZoneNameForDb": {
            "type": "string"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
            "name": "[variables('databaseResourcesDeployment')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "condition": "[parameters('isVnetEnabled')]",
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
                            "name": "[concat(variables('databaseResourcesDeployment'), '-vnet')]",
                            "properties": {
                                "mode": "Incremental",
                                "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "variables": {},
                                    "resources": [
                                        {
                                            "type": "Microsoft.Network/virtualNetworks/subnets",
                                            "apiVersion": "[variables('vnetDeploymentApiVersion')]",
                                            "name": "[concat(parameters('vnetName'), '/', parameters('subnetForDb'))]",
                                            "properties": {
                                                "delegations": [
                                                    {
                                                        "name": "dlg-database",
                                                        "properties": {
                                                            "serviceName": "Microsoft.DBforPostgreSQL/flexibleServers"
                                                        }
                                                    }
                                                ],
                                                "serviceEndpoints": [],
                                                "addressPrefix": "[variables('subnetAddressForDb')]"
                                            }
                                        }
                                    ]
                                }
                            },
                            "dependsOn": []
                        },
                        {
                            "apiVersion": "[variables('databaseApiVersion')]",
                            "location": "[parameters('location')]",
                            "name": "[parameters('serverName')]",
                            "type": "Microsoft.DBforPostgreSQL/flexibleServers",
                            "tags": {},
                            "properties": {
                                "version": "[variables('databaseVersion')]",
                                "administratorLogin": "[parameters('serverUsername')]",
                                "administratorLoginPassword": "[parameters('serverPassword')]",
                                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                                "haEnabled": "[parameters('haEnabled')]",
                                "storageProfile": {
                                    "storageMB": "[parameters('storageSizeMB')]",
                                    "backupRetentionDays": "[parameters('backupRetentionDays')]",
                                    "geoRedundantBackup": "[parameters('geoRedundantBackup')]"
                                },
                                "availabilityZone": "[parameters('availabilityZone')]"
                            },
                            "sku": {
                                "name": "[parameters('postgreServerSkuName')]",
                                "tier": "[parameters('serverEdition')]"
                            },
                            "dependsOn": []
                        }
                    ]
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments', '/', variables('vnetResourcesDeployment'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
            "name": "[variables('appServiceResourcesDeployment')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "apiVersion": "[variables('appServicesApiVersion')]",
                            "name": "[parameters('hostingPlanName')]",
                            "type": "Microsoft.Web/serverfarms",
                            "location": "[parameters('location')]",
                            "kind": "linux",
                            "tags": {},
                            "properties": {
                                "name": "[parameters('hostingPlanName')]",
                                "workerSize": "[parameters('workerSize')]",
                                "workerSizeId": "[parameters('workerSizeId')]",
                                "numberOfWorkers": "[parameters('numberOfWorkers')]",
                                "reserved": true
                            },
                            "sku": {
                                "Tier": "[parameters('sku')]",
                                "Name": "[parameters('skuCode')]"
                            }
                        },
                        {
                            "apiVersion": "[variables('appServicesApiVersion')]",
                            "name": "[parameters('name')]",
                            "type": "Microsoft.Web/sites",
                            "location": "[parameters('location')]",
                            "tags": {},
                            "dependsOn": [
                                "[concat('Microsoft.Web/serverfarms/', parameters('hostingPlanName'))]"
                            ],
                            "properties": {
                                "name": "[parameters('name')]",
                                "siteConfig": {
                                    "linuxFxVersion": "[parameters('linuxFxVersion')]",
                                    "appSettings": [
                                        {
                                            "name": "DBHOST",
                                            "value": "itv-lab4"
                                        },
                                        {
                                            "name": "DBUSER",
                                            "value": "monApplication"
                                        },
                                        {
                                            "name": "DBPASS",
                                            "value": "Passw0rd"
                                        },
                                        {
                                            "name": "DBNAME",
                                            "value": "postgres"
                                        }
                                    ],
                                    "vnetRouteAllEnabled": true
                                },
                                "serverFarmId": "[concat('/subscriptions/', parameters('subscriptionId'),'/resourcegroups/', parameters('serverFarmResourceGroup'), '/providers/Microsoft.Web/serverfarms/', parameters('hostingPlanName'))]",
                                "clientAffinityEnabled": false
                            }
                        },
                        {
                            "condition": "[parameters('isVnetEnabled')]",
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
                            "name": "[concat(variables('appServiceResourcesDeployment'), '-vnet')]",
                            "properties": {
                                "mode": "Incremental",
                                "template": {
                                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {},
                                    "variables": {},
                                    "resources": [
                                        {
                                            "type": "Microsoft.Network/virtualNetworks/subnets",
                                            "apiVersion": "[variables('vnetDeploymentApiVersion')]",
                                            "name": "[concat(parameters('vnetName'), '/', parameters('subnetForApp'))]",
                                            "properties": {
                                                "delegations": [
                                                    {
                                                        "name": "dlg-appServices",
                                                        "properties": {
                                                            "serviceName": "Microsoft.Web/serverfarms"
                                                        }
                                                    }
                                                ],
                                                "serviceEndpoints": [],
                                                "addressPrefix": "[variables('subnetAddressForApp')]"
                                            }
                                        },
                                        {
                                            "apiVersion": "[variables('appServicesApiVersion')]",
                                            "name": "[format('{0}/{1}', parameters('name'), 'virtualNetwork')]",
                                            "type": "Microsoft.Web/sites/networkConfig",
                                            "dependsOn": [
                                                "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetForApp'))]"
                                            ],
                                            "properties": {
                                                "subnetResourceId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetForApp'))]"
                                            }
                                        },
                                        {
                                            "condition": "[parameters('isPrivateEndpointForAppEnabled')]",
                                            "apiVersion": "[variables('privateEndpointApiVersion')]",
                                            "name": "[parameters('privateEndpointNameForApp')]",
                                            "location": "[parameters('location')]",
                                            "type": "Microsoft.Network/privateEndpoints",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('privateEndpointSubnet'))]"
                                                },
                                                "privateLinkServiceConnections": [
                                                    {
                                                        "name": "[parameters('privateEndpointNameForApp')]",
                                                        "properties": {
                                                            "privateLinkServiceId": "[resourceId('Microsoft.Web/Sites', parameters('name'))]",
                                                            "groupIds": [
                                                                "sites"
                                                            ]
                                                        }
                                                    }
                                                ]
                                            },
                                            "resources": [
                                                {
                                                    "condition": "[parameters('isPrivateEndpointForAppEnabled')]",
                                                    "type": "privateDnsZoneGroups",
                                                    "apiVersion": "[variables('privateEndpointApiVersion')]",
                                                    "name": "default",
                                                    "location": "[parameters('location')]",
                                                    "properties": {
                                                        "privateDnsZoneConfigs": [
                                                            {
                                                                "name": "[parameters('privateDnsZoneNameForApp')]",
                                                                "properties": {
                                                                    "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneNameForApp'))]"
                                                                }
                                                            }
                                                        ]
                                                    },
                                                    "dependsOn": [
                                                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointNameForApp'))]"
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            },
                            "dependsOn": [
                                "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlanName'))]",
                                "[resourceId('Microsoft.Web/sites', parameters('name'))]"
                            ]
                        }
                    ]
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments', '/', variables('databaseResourcesDeployment'))]",
                "[concat('Microsoft.Resources/deployments', '/', variables('vnetResourcesDeployment'))]"
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
            "name": "[variables('appServiceDatabaseConnectionResourcesDeployment')]",
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "name": {
                        "value": "[parameters('name')]"
                    },
                    "databaseName": {
                        "value": "[parameters('databaseName')]"
                    },
                    "storageSizeMB": {
                        "value": "[parameters('storageSizeMB')]"
                    },
                    "haEnabled": {
                        "value": "[parameters('haEnabled')]"
                    },
                    "availabilityZone": {
                        "value": "[parameters('availabilityZone')]"
                    },
                    "backupRetentionDays": {
                        "value": "[parameters('backupRetentionDays')]"
                    },
                    "geoRedundantBackup": {
                        "value": "[parameters('geoRedundantBackup')]"
                    },
                    "postgreServerSkuName": {
                        "value": "[parameters('postgreServerSkuName')]"
                    },
                    "serverEdition": {
                        "value": "[parameters('serverEdition')]"
                    },
                    "serverName": {
                        "value": "[parameters('serverName')]"
                    },
                    "serverUsername": {
                        "value": "[parameters('serverUsername')]"
                    },
                    "serverPassword": {
                        "value": "[parameters('serverPassword')]"
                    },
                    "publicNetworkAccess": {
                        "value": "[parameters('publicNetworkAccess')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "name": {
                            "type": "string"
                        },
                        "databaseName": {
                            "type": "string"
                        },
                        "storageSizeMB": {
                            "type": "int"
                        },
                        "haEnabled": {
                            "type": "string"
                        },
                        "availabilityZone": {
                            "type": "string"
                        },
                        "backupRetentionDays": {
                            "type": "int"
                        },
                        "geoRedundantBackup": {
                            "type": "string"
                        },
                        "postgreServerSkuName": {
                            "type": "string"
                        },
                        "serverEdition": {
                            "type": "string"
                        },
                        "serverName": {
                            "type": "string"
                        },
                        "serverUsername": {
                            "type": "string"
                        },
                        "serverPassword": {
                            "type": "securestring"
                        },
                        "publicNetworkAccess": {
                            "type": "string"
                        }
                    },
                    "variables": {
                        "appServicesApiVersion": "2018-11-01"
                    },
                    "resources": [
                        {
                            "apiVersion": "[variables('appServicesApiVersion')]",
                            "name": "[concat(parameters('name'), '/', 'connectionstrings')]",
                            "type": "Microsoft.Web/sites/config",
                            "properties": {
                                "defaultConnection": {
                                    "value": "[concat('Database=postgres;Server=','itv-lab4.postgres.database.azure.com',';User Id=',parameters('serverUsername'),'@','itv-lab4.postgres.database.azure.com',';Password=',parameters('serverPassword'))]",
                                    "type": "PostgreSQL"
                                }
                            }
                        }
                    ]
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments', '/', variables('databaseResourcesDeployment'))]",
                "[concat('Microsoft.Resources/deployments', '/', variables('appServiceResourcesDeployment'))]"
            ]
        },
        {
            "condition": "[parameters('isVnetEnabled')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('resourcesDeploymentApiVersion')]",
            "name": "[variables('vnetResourcesDeployment')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Network/virtualNetworks",
                            "apiVersion": "[variables('vnetDeploymentApiVersion')]",
                            "location": "[parameters('location')]",
                            "name": "[parameters('vnetName')]",
                            "properties": {
                                "addressSpace": {
                                    "addressPrefixes": [
                                        "[variables('vnetAddress')]"
                                    ]
                                },
                                "subnets": []
                            },
                            "resources": [
                                {
                                    "type": "subnets",
                                    "apiVersion": "[variables('vnetDeploymentApiVersion')]",
                                    "name": "[parameters('privateEndpointSubnet')]",
                                    "properties": {
                                        "delegations": [],
                                        "serviceEndpoints": [],
                                        "addressPrefix": "[variables('subnetAddressForPrivateEndpoint')]",
                                        "privateEndpointNetworkPolicies": "Disabled"
                                    },
                                    "dependsOn": [
                                        "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                                    ]
                                }
                            ]
                        },
                        {
                            "condition": "[parameters('isPrivateEndpointForAppEnabled')]",
                            "type": "Microsoft.Network/privateDnsZones",
                            "apiVersion": "[variables('privateDnsApiVersion')]",
                            "name": "[parameters('privateDnsZoneNameForApp')]",
                            "location": "global",
                            "resources": [
                                {
                                    "condition": "[parameters('isPrivateEndpointForAppEnabled')]",
                                    "type": "virtualNetworkLinks",
                                    "apiVersion": "[variables('privateDnsApiVersion')]",
                                    "name": "[format('{0}-link', parameters('privateDnsZoneNameForApp'))]",
                                    "location": "global",
                                    "dependsOn": [
                                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneNameForApp'))]"
                                    ],
                                    "properties": {
                                        "virtualNetwork": {
                                            "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                                        },
                                        "registrationEnabled": false
                                    }
                                }
                            ]
                        },
                        {
                            "type": "Microsoft.Network/privateDnsZones",
                            "apiVersion": "[variables('privateDnsApiVersion')]",
                            "name": "[parameters('privateDnsZoneNameForDb')]",
                            "location": "global",
                            "resources": [
                                {
                                    "type": "virtualNetworkLinks",
                                    "apiVersion": "[variables('privateDnsApiVersion')]",
                                    "name": "[format('{0}-vnetlink', parameters('privateDnsZoneNameForDb'))]",
                                    "location": "global",
                                    "dependsOn": [
                                        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneNameForDb'))]"
                                    ],
                                    "properties": {
                                        "virtualNetwork": {
                                            "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                                        },
                                        "registrationEnabled": false
                                    }
                                }
                            ]
                        }
                    ]
                }
            }
        }
    ],
    "variables": {
        "vnetResourcesDeployment": "vnetResourcesDeployment",
        "databaseResourcesDeployment": "databaseResourcesDeployment",
        "appServiceResourcesDeployment": "appServiceResourcesDeployment",
        "appServiceDatabaseConnectionResourcesDeployment": "appServiceDatabaseConnectionResourcesDeployment",
        "resourcesDeploymentApiVersion": "2020-06-01",
        "appServicesApiVersion": "2018-11-01",
        "databaseApiVersion": "2020-02-14-preview",
        "databaseVersion": "12",
        "vnetDeploymentApiVersion": "2020-07-01",
        "privateDnsApiVersion": "2018-09-01",
        "privateEndpointApiVersion": "2021-02-01",
        "vnetAddress": "10.0.0.0/16",
        "subnetAddressForPrivateEndpoint": "10.0.0.0/24",
        "subnetAddressForApp": "10.0.2.0/24",
        "subnetAddressForDb": "10.0.1.0/24"
    }
}